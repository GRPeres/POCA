@page "/materia-sala/{idMateria:int}"
@using POCA.Web.Response
@using MudBlazor
@inject POCA.Web.Services.APIs.ProfessoresAPI ProfessoresAPI
@inject POCA.Web.Services.APIs.MateriasAPI MateriasAPI
@inject POCA.Web.Services.APIs.AtividadesAPI AtividadesAPI
@inject POCA.Web.Services.APIs.RespostasAPI RespostasAPI
@inject UserSessionService UserSession
@inject NavigationManager NavigationManager

<PageTitle>Mat√©ria</PageTitle>

<MudPaper Class="p-6 max-w-screen-lg mx-auto">
    @if (!UserSession.IsLoggedIn)
    {
        <MudGrid Elevation="1" Class="pa-4 ma-4 text-center">
            <MudText Typo="Typo.h6" Class="mb-4">Voc√™ n√£o est√° logado</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/login">Fazer Login</MudButton>
        </MudGrid>
    }
    else if (materia is null)
    {
        <MudGrid class="d-flex justify-center mt-10">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
        </MudGrid>
    }
    else
    {
        <MudStack Row Class="ma-8 mt-10 gap-6">
            <MudText Typo="Typo.h5">@materia.NomeMateria</MudText>

            @if (UserSession.CurrentUser?.IsProfessor == true && !string.IsNullOrWhiteSpace(nomeProfessor))
            {
                <MudText Typo="Typo.subtitle2" Class="ml-4 text-secondary">
                    (Prof. @nomeProfessor)
                </MudText>
            }
        </MudStack>

        @if (mediaAluno.HasValue && mediaAluno.Value < 5)
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
                Sua m√©dia est√° baixa (@mediaAluno). Vamos fazer um refor√ßo?
                <MudButton Color="Color.Error" Variant="Variant.Outlined" Class="ml-4" OnClick="IrParaReforco">
                    Fazer Refor√ßo
                </MudButton>
            </MudAlert>
        }

        <MudExpansionPanels MultiExpansion="true" ExpandIcon="@Icons.Material.Filled.ExpandMore">
            <MudExpansionPanel Text="Geral">
                <MudList T="string" Dense="true">
                    <MudListItem Icon="@Icons.Material.Filled.Notifications">Avisos</MudListItem>

                    @if (UserSession.CurrentUser?.IdAluno != null)
                    {
                        <MudListItem>
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Secondary"
                                       OnClick="@ObterMediaAlunoAsync"
                                       StartIcon="@Icons.Material.Filled.Calculate">
                                Calcular M√©dia
                            </MudButton>
                        </MudListItem>

                        @if (mediaAluno.HasValue)
                        {
                            <MudListItem>
                                <MudText Typo="Typo.body1">
                                    M√©dia atual: @mediaAluno.Value.ToString("F2")
                                </MudText>
                            </MudListItem>
                        }
                    }
                </MudList>
            </MudExpansionPanel>

            <MudExpansionPanel Text="Quizes e Atividades">
                @if (avaliacoes.Any())
                {
                    @foreach (var a in avaliacoes)
                    {
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Class="mb-2"
                                   OnClick="@(() => NavegarParaAtividade(a.IdAtividade))"
                                   StartIcon="@Icons.Material.Filled.Assignment">
                            @a.NomeAtividade
                        </MudButton>
                    }
                }
                else
                {
                    <MudText>Nenhuma atividade encontrada.</MudText>
                }
            </MudExpansionPanel>

            <MudExpansionPanel Text="Materiais">
                @if (materiais.Any())
                {
                    @foreach (var m in materiais)
                    {
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Folder">@m.Titulo</MudListItem>
                    }
                }
                else
                {
                    <MudText>Nenhum material encontrado.</MudText>
                }
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
</MudPaper>

@code {
    [Parameter] public int idMateria { get; set; }

    private MateriaResponse? materia;
    private string? nomeProfessor;
    private List<AtividadeResponse> avaliacoes = new();
    private List<ItemMateria> materiais = new();
    private double? mediaAluno;

    protected override async Task OnInitializedAsync()
    {
        UserSession.OnChange += HandleUserSessionChanged;

        if (UserSession.IsLoggedIn)
        {
            await MateriasAtividades();
            await ObterMediaAlunoAsync();
        }
    }

    private async Task MateriasAtividades()
    {
        materia = await MateriasAPI.GetMateriaAsync(idMateria);

        if (materia is not null)
        {
            // Buscar atividades
            if (materia.tbAtividadesIdAtividades is not null)
            {
                foreach (var id in materia.tbAtividadesIdAtividades)
                {
                    var atividade = await AtividadesAPI.GetAtividadeByIdAsync(id);
                    if (atividade is not null)
                        avaliacoes.Add(atividade);
                }
            }

            // Buscar nome do professor
            if (UserSession.CurrentUser?.IsProfessor == true)
            {
                var idProf = materia.tbProfessoresIdProfessors?.FirstOrDefault();
                if (idProf.HasValue)
                {
                    var professor = await ProfessoresAPI.GetProfessorbyidAsync(idProf.Value);
                    nomeProfessor = professor?.NomeProfessor;
                }
            }

            // Mock de materiais
            materiais = new()
            {
                new("Slides - Introdu√ß√£o"),
                new("PDF - Leitura obrigat√≥ria")
            };
        }
    }

    private async Task ObterMediaAlunoAsync()
    {
        var idAluno = UserSession.CurrentUser?.IdAluno;
        if (idAluno is null)
            return;

        try
        {
            var resultado = await RespostasAPI.GetMediaPorMateriaAsync(idAluno.Value, idMateria);

            if (resultado is not null)
            {
                mediaAluno = resultado.Media;
            }
            else
            {
                mediaAluno = 0;
            }

            StateHasChanged();
        }
        catch
        {
            mediaAluno = null;
        }
    }

    // üî•üî•üî• ADICIONAR ESTA FUN√á√ÉO
    private void IrParaReforco()
    {
        var idAluno = UserSession.CurrentUser?.IdAluno;
        if (idAluno is null)
            return;

        NavigationManager.NavigateTo($"/reforcoatividade/{idAluno}/{idMateria}");
    }

    private void HandleUserSessionChanged() =>
        InvokeAsync(async () =>
        {
            if (UserSession.IsLoggedIn)
            {
                await MateriasAtividades();
                await ObterMediaAlunoAsync();
                StateHasChanged();
            }
        });

    private void NavegarParaAtividade(int idAtividade) =>
        NavigationManager.NavigateTo($"/atividadepage/{idAtividade}");

    public record ItemMateria(string Titulo);
    public record MediaResponse(double Media, int Acertos, int Total);
}
