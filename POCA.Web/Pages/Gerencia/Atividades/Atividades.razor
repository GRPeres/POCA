@page "/atividades"
@using POCA.Web.Services.APIs
@inject AtividadesAPI AtividadesAPI
@inject QuestoesAPI QuestoesAPI
@inject MateriasAPI MateriasAPI
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<!-- Activities Table / Cards -->
<MudPaper Elevation="2" Class="overflow-hidden">

    <!-- Desktop Table -->
    <div class="d-none d-md-block">
        <MudTable Items="@FilteredActivities"
                  Dense="true"
                  Hover="true"
                  Bordered="true"
                  Loading="@_isLoading">
            <ToolBarContent>
                <MudText Typo="Typo.body2" Class="ml-2">
                    Total: @FilteredActivities.Count() atividades
                </MudText>
                <MudSpacer />
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="RefreshData">
                    Atualizar
                </MudButton>
            </ToolBarContent>

            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>Nome</MudTh>
                <MudTh>Questões</MudTh>
                <MudTh class="text-center">Ações</MudTh>
            </HeaderContent>

            <RowTemplate Context="atividade">
                <MudTd>@atividade.IdAtividade</MudTd>
                <MudTd>@atividade.NomeAtividade</MudTd>
                <MudTd>
                    @if (atividade.TbQuestoesIdQuestoes?.Count() > 0)
                    {
                        <div class="d-flex flex-wrap gap-1">
                            @foreach (var questaoId in atividade.TbQuestoesIdQuestoes)
                            {
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary">
                                    Q-@questaoId
                                </MudChip>
                            }
                        </div>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Transparent">Nenhuma</MudText>
                    }
                </MudTd>
                <MudTd>
                    <div class="d-flex justify-center">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       Href="@($"/atividade/{atividade.IdAtividade}")" />

                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Color="Color.Secondary"
                                       Size="Size.Small"
                                       Href="@($"/editar-atividade/{atividade.IdAtividade}")"
                                       Class="ml-2" />

                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() => OpenDeleteDialog(atividade.IdAtividade))"
                                       Class="ml-2" />
                    </div>
                </MudTd>
            </RowTemplate>

            <PagerContent>
                <MudTablePager PageSizeOptions="@(new[] {10, 25, 50})" />
            </PagerContent>
        </MudTable>
    </div>

    <!-- Mobile Header -->
    <div class="d-md-none px-3 pt-2 pb-1">
        <MudText Typo="Typo.h6" Class="mb-0">
            Atividades
        </MudText>

        <MudText Typo="Typo.caption" Color="Color.Secondary">
            @FilteredActivities.Count() atividades encontradas
        </MudText>

        <MudDivider Class="my-2" />
    </div>

    <!-- Mobile Card List -->
    <div class="d-md-none p-2">
        @foreach (var atividade in FilteredActivities)
        {
            <MudPaper Class="pa-3 mb-3 rounded-lg border-success-left mobile-max-height" Elevation="1">

                <!-- Title + ID -->
                <div class="mobile-column">
                    <MudText Typo="Typo.subtitle1">@atividade.NomeAtividade</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @atividade.IdAtividade</MudText>
                </div>

                <!-- Questions Chips -->
                @if (atividade.TbQuestoesIdQuestoes?.Count() > 0)
                {
                    <div class="d-flex flex-wrap gap-1 mt-2 mobile-max-height">
                        @foreach (var questaoId in atividade.TbQuestoesIdQuestoes)
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary"
                                     Class="text-ellipsis">
                                Q-@questaoId
                            </MudChip>
                        }
                    </div>
                }
                else
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">Nenhuma questão</MudText>
                }

                <!-- Actions -->
                <div class="d-flex justify-end gap-2 mt-3 mobile-buttons">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Visibility"
                               Href="@($"/atividade/{atividade.IdAtividade}")"
                               Class="mobile-full">
                        Ver
                    </MudButton>

                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Edit"
                               Href="@($"/editar-atividade/{atividade.IdAtividade}")"
                               Class="mobile-full">
                        Editar
                    </MudButton>

                    <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete"
                               OnClick="@(() => OpenDeleteDialog(atividade.IdAtividade))"
                               Class="mobile-full">
                        Excluir
                    </MudButton>
                </div>
            </MudPaper>
        }
    </div>

</MudPaper>

@code {
    private List<AtividadeResponse> _atividades = new();
    private bool _isLoading = true;
    private string _searchString = "";
    private MudDialog deleteDialog;
    private int _activityToDeleteId;

    protected override async Task OnInitializedAsync()
    {
        await LoadActivities();
    }

    private async Task LoadActivities()
    {
        _isLoading = true;
        try
        {
            var response = await AtividadesAPI.GetAtividadesAsync();
            _atividades = response?.ToList() ?? new();
        }
        catch (Exception ex)
        {
            // Snackbar.Add($"Erro ao carregar atividades: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshData()
    {
        await LoadActivities();
    }

    private IEnumerable<AtividadeResponse> FilteredActivities => _atividades
        .Where(a => string.IsNullOrWhiteSpace(_searchString) ||
                    a.NomeAtividade.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                    a.IdAtividade.ToString().Contains(_searchString))
        .ToList();

    private void ClearFilters()
    {
        _searchString = "";
    }

    private void OpenDeleteDialog(int activityId)
    {
        _activityToDeleteId = activityId;
        deleteDialog.ShowAsync();
    }

    private async Task ConfirmDelete()
    {
        try
        {
            await AtividadesAPI.DeleteAtividadeAsync(_activityToDeleteId);
            Snackbar.Add("Atividade excluída com sucesso!", Severity.Success);
            await LoadActivities();
            await deleteDialog.CloseAsync();
        }
        catch (Exception ex)
        {
            // Snackbar.Add($"Erro ao excluir questão: {ex.Message}", Severity.Error);
            await deleteDialog.CloseAsync();
        }
    }
}