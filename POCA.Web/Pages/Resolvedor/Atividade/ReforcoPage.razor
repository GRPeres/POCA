@page "/reforcoatividade/{idAluno:int}/{idMateria:int}"
@using MudBlazor
@using POCA.Web
@inject UserSessionService UserSession
@inject NavigationManager NavigationManager
@inject POCA.Web.Services.APIs.ReforcoAPI ReforcoAPI
@inject POCA.Web.Services.APIs.QuestoesAPI QuestoesAPI
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-6">
    <MudPaper Class="pa-6" Elevation="3">

        <MudText Typo="Typo.h4" Class="mb-4">Reforço</MudText>

        <MudText Color="Color.Error">@erro</MudText>

        @if (!UserSession.IsLoggedIn)
    {
            <MudStack Class="pa-4 text-center" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Você não está logado</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/login">Fazer Login</MudButton>
            </MudStack>
    }
        else if (isloading)
    {
            <MudStack JustifyContent="Center" Class="my-10">
                <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
            </MudStack>
    }
    else
    {
            @if (MostrarResumo)
            {
                <MudStack Class="pa-4 mb-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-2">Resumo das Respostas</MudText>

                    <MudList T="int" Dense="true">
                        @foreach (var resposta in Resposta)
                {
                            <MudListItem>
                                <MudText>
                                    Resposta: @(resposta != -1 ? "Marcada" : "Não respondida")
                                </MudText>
                            </MudListItem>
                        }
                    </MudList>

                    <MudStack Direction="Row" Spacing="2" Class="mt-4">
                        <MudButton Variant="Variant.Outlined" OnClick="QuestaoVoltar">Voltar</MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="QuestaoProximo">Terminar</MudButton>
                    </MudStack>
                </MudStack>
            }

            else if (MostrarRespostas)
            {
                <MudStack Class="pa-4 mb-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-2">Resultado Final</MudText>
                    <MudText Class="mb-2">Acertos: @QuantidadeCerta</MudText>

                    <MudList T="bool" Dense="true">
                        @foreach (var certo in RespostaFinal)
                            {
                            <MudListItem>
                                <MudText> @(certo ? "✅ Correta" : "❌ Errada") </MudText>
                            </MudListItem>
                        }
                    </MudList>
                </MudStack>
                            }

            else
            {
                <MudStack Class="pa-4 ma-2">
                    <MudText Typo="Typo.subtitle1" Class="mb-4">Questão @(posicao + 1)</MudText>

                    <MudText Typo="Typo.body1" Class="mb-4">@questoes[posicao].EnunciadoQuestao</MudText>

                    <MudGrid xs="12" md="1">
                        <MudRadioGroup T="int"
                                       @bind-Value="currentSelection"
                                       SelectedOption="-1"
                                       Label="Escolha uma opção"
                                       Class="d-flex flex-column gap-2 mb-4">

                            @foreach (var option in ShuffledOptions)
                            {
                                <MudItem>
                                    <MudRadio T="int" Value="@option.Value">@option.Text</MudRadio>
                                </MudItem>
                }
                        </MudRadioGroup>
                    </MudGrid>

                    <MudStack class="justify-space-between mx-8" Row="true">
                        <MudButton Variant="Variant.Outlined"
                                   Disabled="@(posicao == 0)"
                                   OnClick="QuestaoVoltar">
                            Voltar
                </MudButton>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="QuestaoProximo">
                            @((posicao < questoes.Count - 1) ? "Avançar" : "Terminar")
                        </MudButton>
                    </MudStack>
            </MudStack>
            }
    }
</MudPaper>
</MudContainer>

@code {

    [Parameter] public int idAluno { get; set; }
    [Parameter] public int idMateria { get; set; }

    public List<QuestaoResponse> questoes = new();
    public List<int> Resposta = new();
    public List<bool> RespostaFinal = new();
    public int posicao = 0;
    public bool isloading = true;
    public string erro = "";
    public bool MostrarResumo = false;
    public bool MostrarRespostas = false;
    public int currentSelection = -1;
    public int QuantidadeCerta = 0;

    // Para opções embaralhadas
    public class OptionItem
    {
        public int Value { get; set; }
        public string Text { get; set; } = "";
        public bool IsCorrect { get; set; }
    }

    private List<OptionItem> ShuffledOptions = new();

    protected override async Task OnInitializedAsync()
    {
        UserSession.OnChange += HandleUserSessionChanged;

        await CarregarReforco();

        await InvokeAsync(StateHasChanged);
    }

    private async Task CarregarReforco()
    {
        try
        {
            // 1️⃣ Busca IDs das questões erradas do aluno nessa matéria
            var idsErradas = await ReforcoAPI.GetReforcoAsync(idAluno, idMateria);

            if (idsErradas == null || idsErradas.Count == 0)
            {
                erro = "Nenhuma questão de reforço disponível.";
                isloading = false;
                return;
            }

            // 2️⃣ Gera novas questões com base nos IDs
            var novasQuestoes = await QuestoesAPI.GenerateBasedOnExistingAsync(idsErradas);

            if (novasQuestoes == null || novasQuestoes.Count == 0)
            {
                erro = "Erro ao gerar questões de reforço.";
                isloading = false;
                return;
            }

            questoes = novasQuestoes;

            // 3️⃣ Inicializa arrays de respostas
            Resposta = Enumerable.Repeat(-1, questoes.Count).ToList();
            RespostaFinal = Enumerable.Repeat(false, questoes.Count).ToList();

            currentSelection = Resposta[0];

            ShuffleCurrentQuestionOptions();
        }
        catch (Exception ex)
        {
            erro = "Erro ao gerar reforço.";
            Console.WriteLine(ex);
        }

        isloading = false;
    }

    private void ShuffleCurrentQuestionOptions()
            {
        if (questoes.Count == 0) return;

        var q = questoes[posicao];

        var options = new List<OptionItem>
                {
            new OptionItem { Value = 1, Text = q.RespostaCertaQuestao, IsCorrect = true },
            new OptionItem { Value = 2, Text = q.RespostaErrada1Questao },
            new OptionItem { Value = 3, Text = q.RespostaErrada2Questao },
            new OptionItem { Value = 4, Text = q.RespostaErrada3Questao }
                };

        var rng = new Random();
        ShuffledOptions = options.OrderBy(x => rng.Next()).ToList();
    }

    private void VerificarResposta()
    {
        QuantidadeCerta = 0;

        for (int i = 0; i < Resposta.Count; i++)
        {
            if (Resposta[i] == 1)
            {
                QuantidadeCerta++;
                RespostaFinal[i] = true;
            }
            else
            {
                RespostaFinal[i] = false;
            }
        }
    }

    public void QuestaoProximo()
    {
        if (MostrarResumo)
        {
            VerificarResposta();
            MostrarResumo = false;
            MostrarRespostas = true;
            return;
            }

        Resposta[posicao] = currentSelection;

        if (posicao < questoes.Count - 1)
        {
            posicao++;
            currentSelection = Resposta[posicao];
        }
        else
        {
            posicao = 0;
            MostrarResumo = true;
        }

        ShuffleCurrentQuestionOptions();
    }

    public void QuestaoVoltar()
    {
        if (MostrarResumo)
        {
            MostrarResumo = false;
            MostrarRespostas = false;
            return;
        }

        Resposta[posicao] = currentSelection;

        if (posicao > 0)
        {
            posicao--;
            currentSelection = Resposta[posicao];
        }

        ShuffleCurrentQuestionOptions();
    }

    private void HandleUserSessionChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        UserSession.OnChange -= HandleUserSessionChanged;
    }
}
