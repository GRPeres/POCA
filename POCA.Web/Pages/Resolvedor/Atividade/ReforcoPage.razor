@page "/reforcoatividade/{idAluno:int}/{idMateria:int}"
@using MudBlazor
@using POCA.Web
@inject UserSessionService UserSession
@inject NavigationManager NavigationManager
@inject POCA.Web.Services.APIs.ReforcoAPI ReforcoAPI
@inject POCA.Web.Services.APIs.QuestoesAPI QuestoesAPI


<MudContainer MaxWidth="MaxWidth.Medium" Class="py-6">
    <MudPaper Class="pa-6" Elevation="3">
        <MudText Typo="Typo.h4" Class="mb-4">Reforço</MudText>

        @if (!UserSession.IsLoggedIn)
        {
            <MudStack Class="pa-4 text-center" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Você não está logado</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/login">Fazer Login</MudButton>
            </MudStack>
        }
        else if (isloading)
        {
            <MudStack AlignItems="AlignItems.Center" JustifyContent="Center" Class="my-10">
                <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
            </MudStack>
        }
        else if (questoes.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled">
                Não foram encontradas questões erradas para gerar reforço.
            </MudAlert>
        }
        else
        {
            @if (MostrarResumo)
            {
                <MudStack Class="pa-4 mb-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-2">Resumo das Respostas</MudText>

                    <MudList T="int" Dense="true">
                        @foreach (var resposta in Resposta)
                        {
                            <MudListItem>
                                <MudText>Resposta: @(resposta != -1 ? "Marcada" : "Não marcada")</MudText>
                            </MudListItem>
                        }
                    </MudList>

                    <MudStack Direction="Row" Spacing="2" Class="mt-4">
                        <MudButton Variant="Variant.Outlined" OnClick="QuestaoVoltar">Voltar</MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="QuestaoProximo">Terminar</MudButton>
                    </MudStack>
                </MudStack>
            }
            else if (MostrarRespostas)
            {
                <MudStack Class="pa-4 mb-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-2">Resultado Final</MudText>
                    <MudText Class="mb-2">Quantidade de acertos: @QuantidadeCerta</MudText>

                    <MudList T="int" Dense="true">
                        @foreach (var certo in RespostaFinal)
                        {
                            <MudListItem>
                                <MudText>Questão: @(certo ? "✅ Correta" : "❌ Errada")</MudText>
                            </MudListItem>
                        }
                    </MudList>
                </MudStack>
            }
            else
            {
                <MudStack Class="pa-4 ma-2">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">Questão @(posicao + 1)</MudText>

                    <MudText Typo="Typo.body1" Class="mb-4">@questoes[posicao].EnunciadoQuestao</MudText>

                    <MudRadioGroup T="int" @bind-Value="currentSelection"
                                   SelectedOption="-1"
                                   Label="Escolha uma opção"
                                   Class="d-flex flex-column gap-2 mb-4">

                        @foreach (var option in ShuffledOptions)
                        {
                            <MudItem>
                                <MudRadio T="int" Value="@option.Value">@option.Text</MudRadio>
                            </MudItem>
                        }
                    </MudRadioGroup>

                    <MudStack class="justify-space-between mx-8" Row="true">
                        <MudButton Variant="Variant.Outlined"
                                   Disabled="@(posicao == 0)"
                                   OnClick="QuestaoVoltar">
                            Voltar
                        </MudButton>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="QuestaoProximo">
                            @((posicao < questoes.Count - 1) ? "Avançar" : "Terminar")
                        </MudButton>
                    </MudStack>
                </MudStack>
            }
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public int idAluno { get; set; }
    [Parameter] public int idMateria { get; set; }

    public List<QuestaoResponse> questoes = new();
    public List<int> Resposta = new();
    public List<bool> RespostaFinal = new();
    public int posicao = 0;
    public bool isloading = true;
    public bool MostrarResumo = false;
    public bool MostrarRespostas = false;
    public int currentSelection = -1;
    public int QuantidadeCerta = 0;

    public class OptionItem
    {
        public int Value { get; set; }
        public string Text { get; set; } = "";
        public bool IsCorrect { get; set; }
    }

    private List<OptionItem> ShuffledOptions = new();

    protected override async Task OnInitializedAsync()
    {
        await CarregarReforco();
        ShuffleCurrentQuestionOptions();
    }

    public async Task CarregarReforco()
    {
        try
        {
            var ids = await ReforcoAPI.GetReforcoAsync(idAluno, idMateria);

            foreach (var id in ids)
            {
                var questao = await QuestoesAPI.GetQuestaoByIdAsync(id);
                if (questao != null)
                    questoes.Add(questao);
            }
        }
        catch
        {
            // ignore
        }

        Resposta = Enumerable.Repeat(-1, questoes.Count).ToList();
        RespostaFinal = Enumerable.Repeat(false, questoes.Count).ToList();
        currentSelection = Resposta.Any() ? Resposta[0] : -1;
        isloading = false;
    }

    private void ShuffleCurrentQuestionOptions()
    {
        if (!questoes.Any() || posicao >= questoes.Count)
            return;

        var q = questoes[posicao];



        var options = new List<OptionItem>
        {
            new OptionItem { Value = 1, Text = q.RespostaCertaQuestao, IsCorrect = true },
            new OptionItem { Value = 2, Text = q.RespostaErrada1Questao, IsCorrect = false },
            new OptionItem { Value = 3, Text = q.RespostaErrada2Questao, IsCorrect = false },
            new OptionItem { Value = 4, Text = q.RespostaErrada3Questao, IsCorrect = false },
        };

        var rng = new Random();
        ShuffledOptions = options.OrderBy(x => rng.Next()).ToList();
    }


    public void VerificarResposta()
    {
        QuantidadeCerta = 0;

        for (int i = 0; i < Resposta.Count; i++)
        {
            // Valor == 1 é sempre a correta (antes do embaralhamento)
            if (Resposta[i] == 1)
            {
                QuantidadeCerta++;
                RespostaFinal[i] = true;
            }
        }
    }

    public void QuestaoProximo()
    {
        if (MostrarResumo)
        {
            VerificarResposta();
            MostrarRespostas = true;
            MostrarResumo = false;
            return;
        }

        Resposta[posicao] = currentSelection;


        if (posicao < questoes.Count - 1)
        {
            posicao++;
            currentSelection = Resposta[posicao];
        }
        else
        {
            posicao = 0;
            MostrarResumo = true;
        }

        ShuffleCurrentQuestionOptions();
    }

    public void QuestaoVoltar()
    {
        if (MostrarResumo)
        {
            MostrarResumo = false;
            return;
        }

        Resposta[posicao] = currentSelection;
        posicao--;
        currentSelection = Resposta[posicao];
        ShuffleCurrentQuestionOptions();
    }
}