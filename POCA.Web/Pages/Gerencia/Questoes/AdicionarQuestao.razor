@page "/adicionar-questao"
@using POCA.Web.Services.APIs
@inject QuestoesAPI QuestoesService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-4 px-2 px-sm-0">
    <MudPaper Elevation="4" Class="pa-4 pa-sm-6 rounded-lg">

        <!-- Header -->
        <div class="d-flex align-center mb-4 flex-wrap">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                           Color="Color.Primary"
                           Variant="Variant.Text"
                           Href="/questoes"
                           Class="mr-2 mb-2 mb-sm-0" />
            <MudText Typo="Typo.h5" TypoSm="Typo.h4">Adicionar Nova Questão</MudText>
        </div>

        <!-- Tabs -->
        <MudTabs>
            <!-- Manual Creation Tab -->
            <MudTabPanel Text="Manual">
                <MudForm @ref="_form" @bind-IsValid="_isValid" @bind-Errors="_errors">

                    <!-- Question Text -->
                    <MudTextField @bind-Value="questaoModelo.EnunciadoQuestao"
                                  Label="Enunciado da Questão *"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="O enunciado é obrigatório"
                                  Lines="3"
                                  Class="mb-4"
                                  FullWidth="true" />

                    <!-- Correct Answer -->
                    <MudPaper Elevation="1" Class="pa-4 mb-4 rounded-lg border-success-left">
                        <MudText Typo="Typo.subtitle2" TypoSm="Typo.subtitle1" Color="Color.Success" Class="mb-2">
                            Resposta Correta *
                        </MudText>
                        <MudTextField @bind-Value="questaoModelo.RespostaCertaQuestao"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="A resposta correta é obrigatória"
                                      FullWidth="true" />
                    </MudPaper>

                    <!-- Incorrect Answers -->
                    <MudPaper Elevation="1" Class="pa-4 mb-4 rounded-lg border-error-left">
                        <MudText Typo="Typo.subtitle2" TypoSm="Typo.subtitle1" Color="Color.Error" Class="mb-2">
                            Respostas Incorretas *
                        </MudText>
                        <MudStack Spacing="2">
                            <MudTextField @bind-Value="questaoModelo.RespostaErrada1Questao"
                                          Label="Opção 1"
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          RequiredError="Campo obrigatório"
                                          FullWidth="true" />
                            <MudTextField @bind-Value="questaoModelo.RespostaErrada2Questao"
                                          Label="Opção 2"
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          RequiredError="Campo obrigatório"
                                          FullWidth="true" />
                            <MudTextField @bind-Value="questaoModelo.RespostaErrada3Questao"
                                          Label="Opção 3"
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          RequiredError="Campo obrigatório"
                                          FullWidth="true" />
                        </MudStack>
                    </MudPaper>

                    <!-- Difficulty and Topic -->
                    <MudGrid Spacing="2" Class="mb-4">
                        <MudItem xs="12" sm="6">
                            <MudSelect @bind-Value="questaoModelo.DificuldadeQuestao"
                                       Label="Dificuldade *"
                                       Variant="Variant.Outlined"
                                       Required="true"
                                       RequiredError="Selecione a dificuldade"
                                       FullWidth="true">
                                <MudSelectItem Value="@("Fácil")">Fácil</MudSelectItem>
                                <MudSelectItem Value="@("Médio")">Médio</MudSelectItem>
                                <MudSelectItem Value="@("Difícil")">Difícil</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect @bind-Value="questaoModelo.TemaQuestao"
                                       Label="Tema *"
                                       Variant="Variant.Outlined"
                                       Required="true"
                                       RequiredError="Selecione o tema"
                                       FullWidth="true">
                                <MudSelectItem Value="@("Teoria")">Teoria</MudSelectItem>
                                <MudSelectItem Value="@("Programação")">Programação</MudSelectItem>
                                <MudSelectItem Value="@("Matemática")">Matemática</MudSelectItem>
                                <MudSelectItem Value="@("Lógica")">Lógica</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    </MudGrid>

                    <!-- Buttons -->
                    <MudDivider Class="my-4" />
                    <div class="d-flex flex-column flex-sm-row justify-space-between gap-2">
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Primary"
                                   Href="/questoes"
                                   StartIcon="@Icons.Material.Filled.Cancel"
                                   Class="w-100 w-sm-auto">
                            Cancelar
                        </MudButton>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   EndIcon="@Icons.Material.Filled.Save"
                                   OnClick="HandleSubmit"
                                   Disabled="@(!_isValid || _isSubmitting)"
                                   Class="w-100 w-sm-auto ml-sm-auto">
                            @(_isSubmitting ? "Salvando..." : "Salvar Questão")
                        </MudButton>
                    </div>
                </MudForm>
            </MudTabPanel>

            <!-- AI Generation Tab -->
            <MudTabPanel Text="Gerar com AI">
                <MudTextField @bind-Value="_aiPrompt"
                              Label="Digite o prompt para gerar questões"
                              Variant="Variant.Outlined"
                              Lines="4"
                              FullWidth="true"
                              Placeholder="Ex: Crie 5 questões de múltipla escolha sobre fotossíntese" />

                <MudButton Variant="Variant.Filled"
                           Color="Color.Secondary"
                           OnClick="GenerateFromAI"
                           Class="mt-3 w-100 w-sm-auto"
                           Disabled="@string.IsNullOrWhiteSpace(_aiPrompt)">
                    Gerar Questões
                </MudButton>

                <MudList T="string" Dense="true" Class="mt-4 mobile-max-height">
                    @if (_generatedQuestions?.Any() == true)
                    {
                        @foreach (var q in _generatedQuestions)
                        {
                            <MudListItem>@q</MudListItem>
                        }
                    }
                </MudList>
            </MudTabPanel>
        </MudTabs>
    </MudPaper>
</MudContainer>


@code {
    private MudForm _form;
    private bool _isValid;
    private bool _isSubmitting;
    private string[] _errors = Array.Empty<string>();

    private QuestaoModelo questaoModelo = new();
    private string _aiPrompt;
    private List<string> _generatedQuestions = new();

    private async Task HandleSubmit()
    {
        QuestaoRequest questao = new(
            questaoModelo.EnunciadoQuestao,
            questaoModelo.RespostaCertaQuestao,
            questaoModelo.RespostaErrada1Questao,
            questaoModelo.RespostaErrada2Questao,
            questaoModelo.RespostaErrada3Questao,
            questaoModelo.DificuldadeQuestao,
            questaoModelo.TemaQuestao);

        await _form.Validate();
        if (!_isValid) return;

        _isSubmitting = true;

        try
        {
            await QuestoesService.AddQuestaoAsync(questao);
            Snackbar.Add("Questão adicionada com sucesso!", Severity.Success);
            NavManager.NavigateTo("/questoes");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar questão: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task GenerateFromAI()
    {
        try
        {
            _generatedQuestions = await QuestoesService.GenerateQuestionsFromPromptAsync(_aiPrompt);
            Snackbar.Add("Questões geradas com sucesso!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao gerar questões: {ex.Message}", Severity.Error);
        }
    }

    public class QuestaoModelo
    {
        public string EnunciadoQuestao { get; set; }
        public string RespostaCertaQuestao { get; set; }
        public string RespostaErrada1Questao { get; set; }
        public string RespostaErrada2Questao { get; set; }
        public string RespostaErrada3Questao { get; set; }
        public string DificuldadeQuestao { get; set; }
        public string TemaQuestao { get; set; }
    }
}
