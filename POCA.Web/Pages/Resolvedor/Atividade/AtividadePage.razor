@page "/atividadepage/{idAtividade:int}"
@using MudBlazor
@using POCA.Web
@inject UserSessionService UserSession
@inject NavigationManager NavigationManager
@inject POCA.Web.Services.APIs.AtividadesAPI AtividadesAPI
@inject POCA.Web.Services.APIs.MateriasAPI MateriasAPI
@inject POCA.Web.Services.APIs.QuestoesAPI QuestoesAPI
@inject POCA.Web.Services.APIs.AlunosAPI AlunosAPI
@inject POCA.Web.Services.APIs.RespostaAPI RespostaAPI

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-6">
    <MudPaper Class="pa-6" Elevation="3">
        <MudText Typo="Typo.h4" Class="mb-4">Atividade</MudText>

        <MudText Color="Color.Error">@erro</MudText>

        @if (!UserSession.IsLoggedIn)
        {
            <MudStack Class="pa-4 text-center" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Você não está logado</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/login">Fazer Login</MudButton>
            </MudStack>
        }
        else if (isLoading)
        {
            <MudStack AlignItems="AlignItems.Center" JustifyContent="Center" Class="my-10">
                <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
            </MudStack>
        }
        else
        {
            @if (MostrarResumo)
            {
                <MudStack Class="pa-4 mb-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-2">Resumo das Respostas</MudText>

                    <MudList T="QuestionState" Dense="true">
                        @foreach (var q in Questions)
                        {
                            <MudListItem>
                                <MudText>Resposta: @(q.Selected != null ? "Marcado" : "Não marcado")</MudText>
                            </MudListItem>
                        }
                    </MudList>

                    <MudStack Direction="Row" Spacing="2" Class="mt-4">
                        <MudButton Variant="Variant.Outlined" OnClick="QuestaoVoltar">Voltar</MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="QuestaoProximo">Terminar</MudButton>
                    </MudStack>
                </MudStack>
            }
            else if (MostrarRespostas)
            {
                <MudStack Class="pa-4 mb-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-2">Resultado Final</MudText>
                    <MudText Class="mb-2">Quantidade de acertos: @QuantidadeCerta</MudText>

                    <MudList T="QuestionState" Dense="true">
                        @foreach (var q in Questions)
                        {
                            <MudListItem>
                                <MudText>Questão: @(q.IsCorrect ? "✅ Correta" : "❌ Errada")</MudText>
                            </MudListItem>
                        }
                    </MudList>
                </MudStack>
            }
            else
            {
                var atual = Questions[posicao];

                <MudStack Class="pa-4 ma-2">
                    <MudText Typo="Typo.subtitle1" Class="mb-4">Questão @(posicao + 1)</MudText>

                    <MudText Typo="Typo.body1" Class="mb-4">@atual.Questao.EnunciadoQuestao</MudText>

                    <MudRadioGroup T="OptionItem"
                                   @bind-Value="atual.Selected"
                                   Label="Escolha uma opção"
                                   Class="d-flex flex-column gap-2 mb-4">

                        @foreach (var option in atual.Options)
                        {
                            <MudItem>
                                <MudRadio T="OptionItem" Value="@option">@option.Text</MudRadio>
                            </MudItem>
                        }
                    </MudRadioGroup>

                    <MudStack class="justify-space-between mx-8" Row="true">
                        <MudButton Variant="Variant.Outlined"
                                   Disabled="@(posicao == 0)"
                                   OnClick="QuestaoVoltar">
                            Voltar
                        </MudButton>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="QuestaoProximo">
                            @((posicao < Questions.Count - 1) ? "Avançar" : "Terminar")
                        </MudButton>
                    </MudStack>
                </MudStack>
            }
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public int idAtividade { get; set; }

    public string erro = "";
    public bool isLoading = true;

    public bool MostrarResumo = false;
    public bool MostrarRespostas = false;

    public class OptionItem
    {
        public string Text { get; set; } = "";
        public bool IsCorrect { get; set; }
    }

    public class QuestionState
    {
        public QuestaoResponse Questao { get; set; } = default!;
        public List<OptionItem> Options { get; set; } = new();
        public OptionItem? Selected { get; set; }
        public bool IsCorrect => Selected?.IsCorrect == true;
    }

    public List<QuestionState> Questions = new();
    public int posicao = 0;
    public int QuantidadeCerta => Questions.Count(q => q.IsCorrect);

    protected override async Task OnInitializedAsync()
    {
        await LoadActivity();
        isLoading = false;
    }

    private async Task LoadActivity()
    {
        try
        {
            var atividade = await AtividadesAPI.GetAtividadeByIdAsync(idAtividade);
            if (atividade == null) return;

            foreach (var qid in atividade.TbQuestoesIdQuestoes)
            {
                var q = await QuestoesAPI.GetQuestaoByIdAsync(qid);
                if (q != null)
                    Questions.Add(CreateQuestionState(q));
            }
        }
        catch
        {
            erro = "Erro ao carregar atividade.";
        }
    }

    private QuestionState CreateQuestionState(QuestaoResponse q)
    {
        var options = new List<OptionItem>
        {
            new() { Text = q.RespostaCertaQuestao,  IsCorrect = true  },
            new() { Text = q.RespostaErrada1Questao, IsCorrect = false },
            new() { Text = q.RespostaErrada2Questao, IsCorrect = false },
            new() { Text = q.RespostaErrada3Questao, IsCorrect = false }
        };

        var rng = new Random();

        return new QuestionState
        {
            Questao = q,
            Options = options.OrderBy(_ => rng.Next()).ToList()
        };
    }

    public void QuestaoProximo()
    {
        // At "Resumo" → finalize + show results
        if (MostrarResumo)
        {
            EnviarPraAPI();
            MostrarResumo = false;
            MostrarRespostas = true;
            return;
        }

        if (posicao == Questions.Count - 1)
        {
            MostrarResumo = true;
            return;
        }

        posicao++;
    }

    public void QuestaoVoltar()
    {
        if (MostrarResumo)
        {
            MostrarResumo = false;
            MostrarRespostas = false;
            return;
        }

        if (posicao > 0)
            posicao--;
    }

    public async void EnviarPraAPI()
    {
        int? idPessoa = UserSession.CurrentUser.IsProfessor
            ? UserSession.CurrentUser.IdProfessor
            : UserSession.CurrentUser.IdAluno;

        foreach (var q in Questions)
        {
            var resposta = new RespostaCreateRequest(
                q.Selected?.Text ?? "",
                idAtividade,
                idPessoa ?? 0,
                q.Questao.IdQuestao
            );

            await RespostaAPI.AddRespostaAsync(resposta);
        }
    }
}
