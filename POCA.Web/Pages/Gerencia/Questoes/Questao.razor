@page "/questao/{id:int}"
@using POCA.Web.Services.APIs
@inject QuestoesAPI QuestoesAPI
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-4 px-2 px-sm-0">
    @if (questao == null)
    {
        <MudPaper Elevation="2" Class="pa-8 d-flex justify-center align-center" style="height: 300px;">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
        </MudPaper>
    }
    else
    {
        <MudPaper Elevation="4" Class="pa-4 pa-sm-6 rounded-lg">

            <!-- Header -->
            <div class="d-flex align-center mb-4 flex-wrap">
                <MudIcon Icon="@Icons.Material.Filled.HelpOutline" Size="Size.Large" Color="Color.Primary" Class="mr-2 mb-2" />
                <MudText Typo="Typo.h6" TypoSm="Typo.h5" Class="mb-0">
                    @questao.EnunciadoQuestao
                </MudText>
            </div>

            <!-- Metadata -->
            <div class="d-flex flex-wrap gap-2 mb-4">
                <MudChip T="string" Color="Color.Secondary" Variant="Variant.Outlined"
                         StartIcon="@Icons.Material.Filled.Category">
                    @questao.TemaQuestao
                </MudChip>

                <MudChip T="string" Color="@GetDifficultyColor(questao.DificuldadeQuestao)"
                         Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.StarHalf">
                    @questao.DificuldadeQuestao
                </MudChip>
            </div>

            <MudDivider Class="my-4" />

            <!-- Correct -->
            <MudPaper Elevation="1" Class="pa-4 mb-4 rounded-lg border-success-left">
                <div class="d-flex align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Class="mr-2" />
                    <MudText Typo="Typo.subtitle1" Color="Color.Success">Resposta Correta</MudText>
                </div>
                <MudPaper Elevation="0" Class="pa-3 rounded" Style="background-color: rgba(var(--mud-palette-success-rgb), 0.1);">
                    <MudText>@questao.RespostaCertaQuestao</MudText>
                </MudPaper>
            </MudPaper>

            <!-- Incorrect -->
            <MudPaper Elevation="1" Class="pa-4 rounded-lg border-error-left">
                <div class="d-flex align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Color="Color.Error" Class="mr-2" />
                    <MudText Typo="Typo.subtitle1" Color="Color.Error">Respostas Incorretas</MudText>
                </div>

                @foreach (var resp in new[]
                            {
                        questao.RespostaErrada1Questao,
                        questao.RespostaErrada2Questao,
                        questao.RespostaErrada3Questao
                        })
                {
                    <MudPaper Elevation="0" Class="pa-3 mb-2 rounded d-flex align-center"
                              Style="background-color: rgba(var(--mud-palette-error-rgb), 0.1);">
                        <MudIcon Icon="@Icons.Material.Filled.Clear" Color="Color.Error" Size="Size.Small" Class="mr-2" />
                        <MudText>@resp</MudText>
                    </MudPaper>
                }
            </MudPaper>

            <MudDivider Class="my-6" />

            <!-- Actions -->
            <div class="d-flex flex-wrap justify-space-between gap-2">
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           Href="/questoes"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           Class="w-100 w-sm-auto">
                    Voltar
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                           Color="Color.Secondary"
                           Href="@($"/editar-questao/{questao.IdQuestao}")"
                           StartIcon="@Icons.Material.Filled.Edit"
                           Class="w-100 w-sm-auto">
                    Editar
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.Delete"
                           Class="w-100 w-sm-auto"
                           OnClick="() => deleteDialog.ShowAsync()">
                    Excluir
                </MudButton>
            </div>
        </MudPaper>
    }
</MudContainer>

<!-- Delete Dialog -->
<MudDialog @ref="deleteDialog" MaxWidth="MaxWidth.ExtraSmall">
    <TitleContent>
        <MudText Typo="Typo.h6">Confirmar Exclusão</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>Deseja realmente excluir esta questão?</MudText>
        <MudText Typo="Typo.body2" Color="Color.Error">Esta ação não pode ser desfeita.</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="() => deleteDialog.CloseAsync()">Cancelar</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="DeleteQuestaoAsync">Excluir</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public int id { get; set; }
    private QuestaoResponse? questao;
    private MudDialog deleteDialog = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            questao = await QuestoesAPI.GetQuestaoByIdAsync(id);
        }
        catch (Exception ex)
        {
            // Snackbar.Add($"Erro ao carregar questão: {ex.Message}", Severity.Error);
        }
    }

    private Color GetDifficultyColor(string difficulty) => difficulty switch
    {
        "Fácil" => Color.Success,
        "Média" => Color.Warning,
        "Difícil" => Color.Error,
        _ => Color.Default
    };

    private async Task DeleteQuestaoAsync()
    {
        try
        {
            await QuestoesAPI.DeleteQuestaoAsync(id);
            Snackbar.Add("Questão excluída com sucesso!", Severity.Success);
            Navigation.NavigateTo("/questoes");
        }
        catch (Exception ex)
        {
            // Snackbar.Add($"Erro ao excluir questão: {ex.Message}", Severity.Error);
            deleteDialog.CloseAsync();
        }
    }
}