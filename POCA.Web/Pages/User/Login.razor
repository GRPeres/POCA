@page "/login"
@using MudBlazor
@using POCA.Web
@using POCA.Web.Requests.Pessoa
@using POCA.Web.Response.Login
@using POCA.Web.Services
@using System.Text
@using System.Web
@inject PessoasAPI PessoasAPI
@inject UserSessionService UserSession
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IConfiguration Configuration
@inject IJSRuntime JS
@inject AuthAPI AuthAPI

<MudPaper Class="pa-6 mx-auto mt-12" Elevation="10" MaxWidth="400px">

    @if (!UserSession.IsLoggedIn)
    {
        <MudText Typo="Typo.h5" Class="mb-4 text-center">Login</MudText>

        @if (LoginFalha)
        {
            <MudAlert Severity="Severity.Error" Dense="true" Class="mb-3">
                Erro ao fazer login, credenciais inválidas.
            </MudAlert>
        }

        <MudTextField @bind-Value="Credenciais.Login"
                      Label="Usuário"
                      Variant="Variant.Outlined"
                      Required
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Person"
                      Class="mb-3" />

        <MudTextField @bind-Value="Credenciais.Senha"
                      Label="Senha"
                      Variant="Variant.Outlined"
                      InputType="(_showPassword ? InputType.Text : InputType.Password)"
                      Adornment="Adornment.End"
                      AdornmentIcon="@(_showPassword? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                      OnAdornmentClick="TogglePasswordVisibility"
                      Required
                      Class="mb-4" />

        <MudStack Direction="Column" Spacing="2">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       Href="/cadastro"
                       FullWidth="true">
                Criar conta
            </MudButton>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="EfetuarLogin"
                       Disabled="@(!IsFormValid || IsLoading)"
                       FullWidth="true">
                @if (IsLoading)
                {
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Small" />
                }
                else
                {
                    <MudText>Entrar</MudText>
                }
            </MudButton>

            <MudDivider Class="my-3" />

            <MudButton Variant="Variant.Outlined" Color="Color.Default" FullWidth="true" OnClick="EfetuarLoginGoogle">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" style="height:18px; margin-right:8px;" />
                Entrar com Google
            </MudButton>
        </MudStack>
    }
    else
    {
        <MudText Typo="Typo.h6" Class="text-center mb-4">
            Você já está logado
        </MudText>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Href="/"
                   FullWidth="true">
            Voltar
        </MudButton>
    }
</MudPaper>

@code {
    private LoginModel Credenciais = new();
    private bool LoginFalha = false;
    private bool IsLoading = false;
    private bool _showPassword = false;
    private DotNetObjectReference<Login>? _dotNetRef;

    private bool IsFormValid =>
        !string.IsNullOrWhiteSpace(Credenciais.Login) &&
        !string.IsNullOrWhiteSpace(Credenciais.Senha);

    private class LoginModel
    {
        public string Login { get; set; } = string.Empty;
        public string Senha { get; set; } = string.Empty;
    }

    protected override void OnInitialized()
    {
        UserSession.OnChange += HandleUserSessionChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var uri = new Uri(NavigationManager.Uri);
            var tokenJson = HttpUtility.ParseQueryString(uri.Query).Get("googleToken");

            if (!string.IsNullOrEmpty(tokenJson))
            {
                var auth = JsonSerializer.Deserialize<PessoaAuthResponse>(tokenJson);
                if (auth != null)
                {
                    await ReceiveGoogleAuth(auth);
                }
            }
        }
    }

    public void Dispose()
    {
        UserSession.OnChange -= HandleUserSessionChanged;
        _dotNetRef?.Dispose();
    }

    private void HandleUserSessionChanged() =>
        InvokeAsync(StateHasChanged);

    private async Task EfetuarLogin()
    {
        LoginFalha = false;
        IsLoading = true;

        try
        {
            var hashedPassword = HashPassword(Credenciais.Senha);

            var authResponse = await PessoasAPI.LoginAsync(
                new PessoaLoginRequest(Credenciais.Login, hashedPassword)
            );

            if (authResponse != null)
            {
                await UserSession.Login(authResponse);
                Snackbar.Add("Login bem-sucedido!", Severity.Success);
                NavigationManager.NavigateTo("/");
                return;
            }

            LoginFalha = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
            LoginFalha = true;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private string HashPassword(string password)
    {
        var pepper = Configuration["Security:Pepper"] ?? "";

        using var sha = System.Security.Cryptography.SHA256.Create();
        var bytes = sha.ComputeHash(Encoding.UTF8.GetBytes(password + pepper));

        return Convert.ToBase64String(bytes);
    }

    private void TogglePasswordVisibility() =>
        _showPassword = !_showPassword;

    // ------------------------------
    // GOOGLE LOGIN (final form)
    // ------------------------------
    private async Task EfetuarLoginGoogle()
    {
        try
        {
            var urlObj = await AuthAPI.GetGoogleLoginUrl();
            if (urlObj?.Url is null)
            {
                Snackbar.Add("Erro ao iniciar login com Google.", Severity.Error);
                return;
            }

            await JS.InvokeVoidAsync("openGooglePopup", urlObj.Url);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro Google: {ex.Message}", Severity.Error);
        }
    }

    [JSInvokable]
    public async Task ReceiveGoogleAuth(PessoaAuthResponse auth)
    {
        await UserSession.Login(auth);

        await InvokeAsync(() =>
        {
            StateHasChanged(); // forces Blazor to re-render
            Snackbar.Add("Login com Google bem-sucedido!", Severity.Success);
            NavigationManager.NavigateTo("/"); // optional redirect
        });

        await UserSession.InitializeAsync();
    }
}
