@page "/materias-aluno"
@using MudBlazor
@using POCA.API.Response
@using POCA.Web
@inject UserSessionService UserSession
@inject NavigationManager NavigationManager
@inject POCA.Web.Services.APIs.AlunosAPI AlunosAPI
@inject POCA.Web.Services.APIs.ProfessoresAPI ProfessoresAPI
@inject POCA.Web.Services.APIs.MateriasAPI MateriasAPI
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<style>
    .cards-wrapper {
        position: relative;
        display: flex;
        flex-direction: row;
        gap: 1rem;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        scroll-behavior: smooth;
        padding-bottom: 1rem;
        user-select: none;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

        .cards-wrapper::-webkit-scrollbar {
            display: none;
        }

    .card-container {
        flex-shrink: 0;
        scroll-snap-align: center;
        width: 250px;
        margin-top: 1rem;
        margin-bottom: 1rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
        position: relative;
        z-index: 1;
    }

        .card-container:hover {
            z-index: 10;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
</style>

<MudLayout>
    <MudMainContent Class="pt-2 pb-0 px-6">
        @if (isLoading)
        {
            <div class="d-flex justify-center mt-10">
                <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
            </div>
        }
        else if (UserSession.IsLoggedIn)
        {
            <MudText Typo="Typo.h4" Class="my-6 font-weight-bold">
                📚 @(UserSession.CurrentUser.IsProfessor ? "Matérias que você leciona" : "Minhas Matérias")
            </MudText>

            @if (materiasProgresso == null || materiasProgresso.Count == 0)
            {
                <MudText>Nenhuma matéria encontrada.</MudText>
            }
            else
            {
                <MudGrid>
                    @foreach (var materia in materiasProgresso)
                    {
                        var progresso = materiasProgresso
                        .FirstOrDefault(p => p.IdMateria == materia.IdMateria);

                        <MudItem xs="12" sm="6" md="3">
                            <!-- 4 columns on md+ -->
                            <MudCard Elevation="6"
                                     Class="hover:shadow-xl transition-all duration-300"
                                     Style="cursor:pointer"
                                     @onclick="() => NavigateToMateria(materia.IdMateria)">

                                <MudCardActions Class="d-flex align-center gap-2 p-4">
                                    <MudIcon Icon="@Icons.Material.Filled.Book"
                                             Color="Color.Primary" />

                                    <MudText Typo="Typo.h6" Class="mb-0">
                                        @materia.NomeMateria
                                    </MudText>

                                    @if (UserSession.CurrentUser?.IdAluno != null && progresso != null)
                                    {
                                        <MudProgressLinear Value="@progresso.Progresso"
                                                           Color="Color.Success"
                                                           Rounded="true"
                                                           Style="height:6px; flex:1; margin-left:10px;" />

                                        <MudText Typo="Typo.caption" Class="ml-2">
                                            @($"{progresso.Progresso:F0}%")
                                        </MudText>
                                    }
                                </MudCardActions>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
        }
        else
        {
            <MudPaper Elevation="1" Class="pa-4 ma-4 text-center">
                <MudText Typo="Typo.h6" Class="mb-4">Você não está logado</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/login">Fazer Login</MudButton>
            </MudPaper>
        }
    </MudMainContent>
</MudLayout>

@code {
    private List<MateriaProgressoResponse> materiasProgresso = new();
    private bool isLoaded = false;
    private bool isLoading = true;
    private bool hasRenderedCards = false;

    [CascadingParameter] public bool IsDarkMode { get; set; }

    protected override async Task OnInitializedAsync()
    {
        UserSession.OnChange += HandleUserSessionChanged;

        if (UserSession.IsLoggedIn && !isLoaded)
        {
            isLoaded = true;
            await CarregarMaterias();
        }

        isLoading = false;
    }

    private async Task CarregarMaterias()
    {
        try
        {
            if (UserSession.CurrentUser == null)
                return;

            if (UserSession.CurrentUser.IdAluno.HasValue && UserSession.CurrentUser.IdAluno.HasValue)
            {
                materiasProgresso = (await MateriasAPI
                    .GetProgressoMateriasAsync(UserSession.CurrentUser.IdAluno.Value))?
                    .ToList() ?? new();
            }
            else if (UserSession.CurrentUser.IdProfessor.HasValue)
            {
                // Mantém o comportamento anterior para professores
                var professor = await ProfessoresAPI.GetProfessorbyidAsync(UserSession.CurrentUser.IdProfessor.Value);
                foreach (var materiaId in professor.MateriasIds)
                {
                    var materia = await MateriasAPI.GetMateriaAsync(materiaId);
                    if (materia != null)
                    {
                        materiasProgresso.Add(new MateriaProgressoResponse
                            {
                                IdMateria = materia.IdMateria,
                                NomeMateria = materia.NomeMateria,
                                TotalAtividades = 0,
                                AtividadesRespondidas = 0,
                                Progresso = 0
                            });
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar matérias: {ex.Message}");
        }

        hasRenderedCards = true;
        await InvokeAsync(StateHasChanged);
    }

    private void HandleUserSessionChanged()
    {
        InvokeAsync(async () =>
        {
            if (UserSession.IsLoggedIn && !isLoaded)
            {
                isLoaded = true;
                await CarregarMaterias();
                StateHasChanged();
            }
        });
    }

    private void NavigateToMateria(int materiaId)
    {
        NavigationManager.NavigateTo($"/materia-sala/{materiaId}");
    }

    public void Dispose()
    {
        UserSession.OnChange -= HandleUserSessionChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (hasRenderedCards)
        {
            var jsCode = @"
            window.enableHorizontalWheel = function(selector) {
                const el = document.querySelector(selector);
                if (!el) return;
                el.addEventListener('wheel', function(e) {
                    if (e.deltaY !== 0) {
                        el.scrollLeft += e.deltaY;
                        e.preventDefault();
                    }
                }, { passive: false });
            };";
            await JSRuntime.InvokeVoidAsync("eval", jsCode);
            await JSRuntime.InvokeVoidAsync("enableHorizontalWheel", ".cards-wrapper");

            hasRenderedCards = false;
        }
    }

    private string GetCardStyle()
    {
        var background = IsDarkMode
            ? "linear-gradient(45deg, #2c2c2c 0, #2c2c2c 10px, #1e1e1e 10px, #1e1e1e 20px)"
            : "repeating-linear-gradient(45deg, #f3f3f3 0, #f3f3f3 10px, #ffffff 10px, #ffffff 20px)";
        return $"height: 350px; background: {background};";
    }
}
