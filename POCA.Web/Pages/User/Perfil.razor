@page "/perfil"
@using MudBlazor
@using POCA.Web
@inject PessoasAPI PessoasAPI
@inject POCA.Web.Services.APIs.AlunosAPI AlunosAPI
@inject POCA.Web.Services.APIs.ProfessoresAPI ProfessoresAPI
@inject UserSessionService UserSession
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar


<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-6">
    @if (UserSession.IsLoggedIn)
    {
        <MudPaper Class="pa-6" Elevation="3">
            @if (paginicial)
            {
                @if (UserSession.CurrentUser != null && UserSession.CurrentUser.IdProfessor.HasValue)
                {
                    <MudText Typo="Typo.h5" Class="mb-4">Perfil do Professor</MudText>


                    <MudGrid>
                        <MudItem xs="12" sm="4">
                            <MudAvatar Size="Size.Large" Icon="@Icons.Material.Filled.Person" />
                        </MudItem>
                        <MudItem xs="12" sm="8">
                            @if (!editMode)
                            {
                                <MudText Class="mt-1">Nome: @Professor.NomeProfessor</MudText>
                                <MudText Class="mt-3">Email: @Professor.ContatoProfessor</MudText>
                                <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="mt-4" OnClick="ToggleEdit">Editar</MudButton>
                            }
                            else
                            {
                                <MudTextField @bind-Value="NomeAlterado" Label="Nome" Variant="Variant.Outlined" FullWidth="true" />
                                <MudTextField @bind-Value="EmailAlterado" Label="Email" Variant="Variant.Outlined" FullWidth="true" Class="mt-3" />
                                <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="mt-4" OnClick="SalvarAlteracoes">Salvar</MudButton>
                                <MudButton Color="Color.Secondary" Variant="Variant.Text" Class="mt-4 ml-2" OnClick="ToggleEdit">Cancelar</MudButton>
                            }
                        </MudItem>
                    </MudGrid>
                }
                else
                {
                    <MudText Typo="Typo.h5" Class="mb-4">Perfil do Aluno</MudText>


                    <MudGrid>
                        <MudItem xs="12" sm="4">
                            <MudAvatar Size="Size.Large" Icon="@Icons.Material.Filled.Person" />
                        </MudItem>
                        <MudItem xs="12" sm="8">
                            @if (!editMode)
                            {
                                <MudText Class="mt-1">Nome: @Aluno.NomeAluno</MudText>
                                <MudText Class="mt-3">Email: @Aluno.EmailAluno</MudText>
                                <MudText Class="mt-3">Contato: @Aluno.ContatoAluno</MudText>
                                <MudText Class="mt-3">Data de Nascimento: @Aluno.NascimentoAluno</MudText>
                                <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="mt-4" OnClick="ToggleEdit">Editar</MudButton>
                            }
                            else
                            {
                                <MudTextField @bind-Value="NomeAlterado"
                                              Label="Nome"
                                              Variant="Variant.Outlined"
                                              FullWidth="true"
                                              OnInput="@( (string _) => ChecarAlteracoes() )" />

                                <MudTextField @bind-Value="EmailAlterado"
                                              Label="Email"
                                              Variant="Variant.Outlined"
                                              FullWidth="true"
                                              Class="mt-3"
                                              OnInput="@( (string _) => ChecarAlteracoes() )" />

                                <MudTextField @bind-Value="ContatoAlterado"
                                              Label="Contato"
                                              Variant="Variant.Outlined"
                                              FullWidth="true"
                                              Class="mt-3"
                                              OnInput="@( (string _) => ChecarAlteracoes() )" />

                                <MudDatePicker Label="Data de Nascimento"
                                               Editable="true"
                                               @bind-Date="DataAlterado"
                                               Variant="Variant.Outlined"
                                               Class="mt-3"
                                               DateFormat="dd/MM/yyyy"
                                               MaxDate="DateTime.Today"
                                               Placeholder="DD/MM/YYYY"
                                               Immediate="true"/>

                                <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="mt-4" Disabled="@(carregando)" OnClick="SalvarAlteracoes">
                                    @if (!carregando)
                                    {
                                        <MudText>Salvar</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.h5" Class="mb-4 text-center">Login</MudText>
                                    }
                                </MudButton>
                                <MudButton Color="Color.Secondary" Variant="Variant.Text" Class="mt-4 ml-2" OnClick="ToggleEdit">Cancelar</MudButton>

                            }
                        </MudItem>
                    </MudGrid>
                }
            }
            else
            {
                <MudGrid>
                    <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
                </MudGrid>
            }
        </MudPaper>
    }
    else if (!UserSession.IsLoggedIn)
    {
        <MudText>Você não está logado</MudText>
        <MudButton Href="/login">Logar</MudButton>
        <MudButton Href="/cadastro">Cadastrar</MudButton>
    }
</MudContainer>
@code
{
    public bool paginicial = false;
    public string Erro = string.Empty;
    public bool editMode = false;
    public bool carregando = false;

    public ProfessorResponse Professor { get; set; } = new ProfessorResponse(0, "", "", "");
    public AlunoResponse Aluno { get; set; } = new AlunoResponse(0, "", DateTime.MinValue, 0, "", "", null, null);

    public bool NomeAlt { get; set; }
    private string NomeAlterado = string.Empty;

    public bool EmailAlt { get; set; }
    private string EmailAlterado = string.Empty;

    public bool ContatoAlt { get; set; }
    private string ContatoAlterado = string.Empty;

    public bool DatAlt { get; set; }
    private DateTime? DataAlterado;

    private void ChecarAlteracoes()
    {
        NomeAlt = NomeAlterado != Aluno.NomeAluno && !string.IsNullOrWhiteSpace(NomeAlterado);
        EmailAlt = EmailAlterado != Aluno.EmailAluno && !string.IsNullOrWhiteSpace(EmailAlterado);
        ContatoAlt = ContatoAlterado != Aluno.ContatoAluno && !string.IsNullOrWhiteSpace(ContatoAlterado);
        DatAlt = DataAlterado != Aluno.NascimentoAluno && DataAlterado != DateTime.MinValue && DataAlterado != null;
    }

    void ToggleEdit() => editMode = !editMode;

    protected override async Task OnInitializedAsync()
    {
        UserSession.OnChange += HandleUserSessionChanged;

        if (UserSession.IsLoggedIn)
        {
            await LoadUserDataAsync();
        }
    }

    public void Dispose()
    {
        UserSession.OnChange -= HandleUserSessionChanged;
    }

    private async void HandleUserSessionChanged()
    {
        if (UserSession.IsLoggedIn)
        {
            await LoadUserDataAsync();
        }
        else
        {
            paginicial = false;
            Erro = "Usuário não está logado.";
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void SalvarAlteracoes()
    {
        carregando = true;
        ChecarAlteracoes();
        try
        {
            DateTime Datamedio = DataAlterado ?? DateTime.MinValue;
            AlunoEditRequest AlunoEdit = new(Aluno.IdAluno,
                                             NomeAlt ? NomeAlterado : Aluno.NomeAluno,
                                             DatAlt ? Datamedio : Aluno.NascimentoAluno,
                                             Aluno.ProgressoAluno,
                                             EmailAlt ? EmailAlterado : Aluno.EmailAluno,
                                             ContatoAlt ? ContatoAlterado : Aluno.ContatoAluno);


            bool Alteracao = await AlunosAPI.UpdateAlunosAsync(AlunoEdit);

            if (Alteracao)
            {
                Snackbar.Add("Alterações feitas", Severity.Success);
                await LoadUserDataAsync();
            }
            else
            {
                Snackbar.Add("Erro na alteração", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Erro = $"Error: {ex.Message}";
        }
        finally
        {
            carregando = false;
            ToggleEdit();
            ResetarVar();
            HandleUserSessionChanged();
        }
    }

    private void ResetarVar()
    {
        NomeAlt = EmailAlt = ContatoAlt = DatAlt = false;
    }

    private async Task LoadUserDataAsync()
    {
        try
        {
            if (UserSession.CurrentUser == null)
            {
                Erro = "Usuário não encontrado.";
                return;
            }

            if (UserSession.CurrentUser.IdProfessor.HasValue)
            {
                Professor = await ProfessoresAPI.GetProfessorbyidAsync(UserSession.CurrentUser.IdProfessor.Value);
            }
            else
            {
                Aluno = await AlunosAPI.GetAlunosbyIDAsync(UserSession.CurrentUser.IdAluno.Value);
            }

            paginicial = true;
        }
        catch (Exception ex)
        {
            Erro = $"Erro: {ex.Message}";
            Console.WriteLine($"Caught exception: {ex}");
        }

        await InvokeAsync(StateHasChanged);
    }
}
