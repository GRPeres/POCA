@page "/adicionar-materia"
@using POCA.Web.Services.APIs
@using POCA.Web.Requests
@inject MateriaAPI MateriaService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-6">
    <MudPaper Elevation="4" Class="pa-6 rounded-lg">
        <!-- Header -->
        <div class="d-flex align-center mb-4">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                           Color="Color.Primary"
                           Variant="Variant.Text"
                           Href="/materias"
                           Class="mr-2" />
            <MudText Typo="Typo.h4">Adicionar Nova Matéria</MudText>
        </div>

        <MudForm @ref="_form" @bind-IsValid="_isValid" @bind-Errors="_errors">
            <!-- Nome da Matéria -->
            <MudTextField @bind-Value="materiaModelo.NomeMateria"
                          Label="Nome da Matéria *"
                          Variant="Variant.Outlined"
                          Required="true"
                          RequiredError="O nome da matéria é obrigatório"
                          Class="mb-4" />

            <!-- Professor ID -->
            <MudTextField @bind-Value="materiaModelo.IdProfessorMateria"
                          Label="ID do Professor *"
                          Variant="Variant.Outlined"
                          Required="true"
                          RequiredError="O ID do professor é obrigatório"
                          HelperText="Insira o ID numérico do professor"
                          InputType="InputType.Number"
                          Class="mb-4" />

            <!-- Aluno ID -->
            <MudTextField @bind-Value="materiaModelo.IdAlunoMateria"
                          Label="ID do Aluno *"
                          Variant="Variant.Outlined"
                          Required="true"
                          RequiredError="O ID do aluno é obrigatório"
                          HelperText="Insira o ID numérico do aluno"
                          InputType="InputType.Number"
                          Class="mb-4" />

            <!-- Action Buttons -->
            <MudDivider Class="my-4" />
            <div class="d-flex justify-space-between">
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           Href="/materias"
                           StartIcon="@Icons.Material.Filled.Cancel">
                    Cancelar
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           EndIcon="@Icons.Material.Filled.Save"
                           OnClick="HandleSubmit"
                           Disabled="@(!_isValid || _isSubmitting)"
                           Class="ml-auto">
                    @(_isSubmitting ? "Salvando..." : "Salvar Matéria")
                </MudButton>
            </div>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    private MudForm _form;
    private bool _isValid = false;
    private bool _isSubmitting = false;
    private string[] _errors = Array.Empty<string>();

    private MateriaModelo materiaModelo = new();

    private async Task HandleSubmit()
    {
        await _form.Validate();
        if (!_isValid) return;

        _isSubmitting = true;

        try
        {
            var materiaRequest = new MateriaRequest(
                materiaModelo.NomeMateria,
                materiaModelo.IdProfessorMateria,
                materiaModelo.IdAlunoMateria
            );

            var result = await MateriaService.AddMateriaAsync(materiaRequest);

            if (result != null)
            {
                Snackbar.Add("Matéria adicionada com sucesso!", Severity.Success);
                NavManager.NavigateTo("/materias");
            }
            else
            {
                Snackbar.Add("Erro ao adicionar matéria.", Severity.Error);
                _isSubmitting = false;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar matéria: {ex.Message}", Severity.Error);
            _isSubmitting = false;
        }
    }

    public class MateriaModelo
    {
        public string NomeMateria { get; set; } = string.Empty;
        public int IdProfessorMateria { get; set; }
        public int IdAlunoMateria { get; set; }
    }
}
