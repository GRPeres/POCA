@page "/perfil"
@using MudBlazor
@using POCA.Web
@inject PessoasAPI PessoasAPI
@inject POCA.Web.Services.APIs.AlunosAPI AlunosAPI
@inject POCA.Web.Services.APIs.ProfessoresAPI ProfessoresAPI
@inject UserSessionService UserSession
@inject NavigationManager NavigationManager

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-6">
    <MudText Color="Color.Error">@Erro</MudText>

    <MudPaper Class="pa-6" Elevation="3">
        @if (paginicial)
        {
            @if (UserSession.CurrentUser != null && UserSession.CurrentUser.IdProfessor.HasValue)
            {
                <MudText Typo="Typo.h5" Class="mb-4">Perfil do Professor</MudText>

                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudAvatar Size="Size.Large" Icon="@Icons.Material.Filled.Person" />
                    </MudItem>
                    <MudItem xs="12" sm="8">
                        <MudTextField Label="Nome" T="string" Variant="Variant.Filled" FullWidth="true">@Professor.NomeProfessor</MudTextField>
                        <MudTextField Label="Email" T="string" Variant="Variant.Filled" FullWidth="true" Class="mt-3">@Professor.ContatoProfessor</MudTextField>
                        <MudTextField Label="Contato" T="string" Variant="Variant.Filled" FullWidth="true" Class="mt-3">@Professor.MateriaProfessor</MudTextField>

                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SalvarPerfil" Class="mt-4">
                            Salvar Alterações
                        </MudButton>
                    </MudItem>
                </MudGrid>
            }
            else
            {
                <MudText Typo="Typo.h5" Class="mb-4">Perfil do Aluno</MudText>

                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudAvatar Size="Size.Large" Icon="@Icons.Material.Filled.Person" />
                    </MudItem>
                    <MudItem xs="12" sm="8">
                        <MudTextField Label="Nome" T="string" Variant="Variant.Filled" FullWidth="true">@Aluno.NomeAluno</MudTextField>
                        <MudTextField Label="Email" T="string" Variant="Variant.Filled" FullWidth="true" Class="mt-3">@Aluno.EmailAluno</MudTextField>
                        <MudTextField Label="Contato" T="string" Variant="Variant.Filled" FullWidth="true" Class="mt-3">@Aluno.ContatoAluno</MudTextField>
                        <MudDatePicker Label="Data de Nascimento" Variant="Variant.Filled" FullWidth="true" Class="mt-3">@Aluno.NascimentoAluno</MudDatePicker>

                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SalvarPerfil" Class="mt-4">
                            Salvar Alterações
                        </MudButton>
                    </MudItem>
                </MudGrid>
            }
        }
        else
        {
            <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
        }


    </MudPaper>
</MudContainer>

@code
{
    public bool paginicial = false;
    public string Erro = string.Empty;
    public ProfessorResponse Professor { get; set; } = new ProfessorResponse(0, "", "", "");
    public AlunoResponse Aluno { get; set; } = new AlunoResponse(0, "", DateTime.MinValue, 0, "", "", null, null);

    protected override async Task OnInitializedAsync()
    {
        UserSession.OnChange += HandleUserSessionChanged;

        if (UserSession.IsLoggedIn)
        {
            await LoadUserDataAsync();
        }
    }

    private async void HandleUserSessionChanged()
    {
        if (UserSession.IsLoggedIn)
        {
            await LoadUserDataAsync();
        }
        else
        {
            paginicial = false;
            Erro = "Usuário não está logado.";
            await InvokeAsync(StateHasChanged);
        }
    }

    protected void SalvarPerfil()
    {
        // Aqui você salvaria no banco de dados
        Erro = "Não existe esse botão";
    }

    private async Task LoadUserDataAsync()
    {
        try
        {
            if (UserSession.CurrentUser == null)
            {
                Console.WriteLine("UserSession.CurrentUser is null");
                Erro = "Usuário não encontrado.";
                return;
            }

            if (UserSession.CurrentUser.IdProfessor.HasValue)
            {
                Professor = await ProfessoresAPI.GetProfessorbyidAsync(UserSession.CurrentUser.IdProfessor.Value);
            }
            else
            {
                Aluno = await AlunosAPI.GetAlunosbyIDAsync(UserSession.CurrentUser.IdAluno.Value);
            }


            paginicial = true;
            Console.WriteLine("paginicial set to true");
        }
        catch (Exception ex)
        {
            Erro = $"Erro: {ex.Message}";
            Console.WriteLine($"Caught exception: {ex}");
        }

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        UserSession.OnChange -= HandleUserSessionChanged;
    }
}